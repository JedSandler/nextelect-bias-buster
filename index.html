<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>NextElect — Issue of the Week</title>
    <style>
        /* ============ Theme ============ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box
        }

        html,
        body {
            height: 100%
        }

        :root {
            --bg: #3c3f46;
            --fg: #f2f2f2;
            --muted: #d5d5d5;
            --tile: #f7f7f7;
            --tile-border: #dcdcdc;
            --green-bg: #d4edda;
            --green-fg: #155724;
            --red-bg: #f8d7da;
            --red-fg: #721c24;
            --accent: #e6e6e6;
            --card: #2b2f36;
            --card-border: #3a3e47;
            --link: #9ecbff;
        }

        body {
            font-family: Verdana, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
            background: var(--bg);
            color: var(--fg);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .hidden {
            display: none !important
        }

        .center {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 12px 12px 24px
        }

        .screen {
            width: 100%;
            max-width: 920px;
            margin: 0 auto
        }

        .brand {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: .8rem;
            margin: 0 0 10px
        }

        .brand img {
            height: 64px
        }

        .brand .logo {
            font-size: 2.2rem
        }

        /* Buttons */
        button {
            font-family: inherit
        }

        .btn {
            background: #34363d;
            color: var(--fg);
            padding: .8rem 1.4rem;
            font-size: 1rem;
            border: 1px solid #474a53;
            border-radius: 10px;
            cursor: pointer;
            transition: background .2s, transform .08s;
        }

        .btn:hover {
            background: #3b3e46;
            transform: translateY(-1px)
        }

        .btn.small {
            padding: .6rem 1rem;
            font-size: .95rem
        }

        .btn-row {
            display: flex;
            gap: .6rem;
            flex-wrap: wrap;
            justify-content: center;
            margin-top: .8rem
        }

        /* Card */
        .card {
            background: var(--card);
            border: 1px solid var(--card-border);
            border-radius: 14px;
            padding: 1rem 1rem;
            box-shadow: 0 12px 30px rgba(0, 0, 0, .25);
        }

        .card h2 {
            font-size: 1.2rem;
            margin-bottom: .6rem
        }

        .muted {
            color: var(--muted)
        }

        .section {
            margin-top: 12px
        }

        /* ===== Summary ===== */
        .summary-title {
            font-size: 1.15rem;
            color: #e9eef7;
            margin-bottom: .35rem
        }

        .summary-text {
            color: #e9eef7;
            line-height: 1.5;
            white-space: pre-wrap
        }

        /* ===== Bias Buster (1 round) ===== */
        .progress-top {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: .75rem;
            margin-bottom: .5rem
        }

        .topic-label {
            font-size: 1rem;
            color: var(--muted)
        }

        .progress-bar-wrap {
            flex: 1;
            height: 8px;
            background: #3a3d46;
            border-radius: 5px;
            overflow: hidden
        }

        #progress-bar {
            height: 100%;
            width: 0%;
            background: var(--accent);
            transition: width .25s ease
        }

        .meta-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin: .4rem 0 .7rem;
            color: var(--muted)
        }

        #boxes {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: .5rem;
            margin-bottom: 1rem
        }

        .box {
            min-height: 56px;
            background: var(--tile);
            border: 1px solid var(--tile-border);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 0 #cfcfcf;
            padding: .5rem;
            color: #202020;
            text-align: center;
        }

        .box.correct {
            border-color: #28a745;
            background: var(--green-bg);
            color: var(--green-fg)
        }

        .box.incorrect {
            border-color: #dc3545;
            background: var(--red-bg);
            color: var(--red-fg)
        }

        @keyframes flash {

            0%,
            100% {
                background: rgba(40, 167, 69, .1)
            }

            50% {
                background: rgba(40, 167, 69, .18)
            }
        }

        .flash {
            animation: flash .5s ease-out
        }

        #headline {
            background: var(--tile);
            color: #111;
            padding: 1.1rem 1rem;
            border-radius: 14px;
            border: 1px solid var(--tile-border);
            box-shadow: 0 2px 0 #cfcfcf;
            margin: .2rem 0 1rem;
            min-height: 3.8rem;
            font-size: 1.2rem;
            line-height: 1.35;
            text-align: center;
            /* centered headline */
        }

        .options {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: .6rem;
            margin: .2rem 0 1rem
        }

        .option-btn {
            background: var(--tile);
            color: #111;
            padding: .9rem .8rem;
            border-radius: 12px;
            border: 1px solid var(--tile-border);
            cursor: pointer;
            transition: transform .06s ease, background .15s ease;
            box-shadow: 0 2px 0 #cfcfcf;
            font-weight: 600
        }

        .option-btn:hover {
            background: #ededed;
            transform: translateY(-1px)
        }

        @keyframes shake {

            0%,
            100% {
                transform: translateX(0)
            }

            25% {
                transform: translateX(-6px)
            }

            75% {
                transform: translateX(6px)
            }
        }

        .shake {
            animation: shake .22s
        }

        .articles {
            display: flex;
            flex-direction: column;
            gap: 10px
        }

        .article {
            background: #2e3138;
            border: 1px solid #4a4f58;
            border-radius: 10px;
            padding: .7rem .8rem
        }

        .article a {
            color: var(--link);
            text-decoration: underline
        }

        /* ===== Timeline ===== */
        .tl-head {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: .75rem;
            flex-wrap: wrap
        }

        .lives {
            color: #ffb3b3;
            font-weight: 600
        }

        .event-scroll {
            width: 100%;
            overflow-x: auto
        }

        .event-list {
            display: flex;
            gap: .6rem;
            padding: .6rem;
            margin: .6rem 0;
            list-style: none;
        }

        .event {
            background: #34363d;
            border: 1px solid #4a4f58;
            border-radius: 12px;
            width: 250px;
            min-height: 120px;
            flex: 0 0 auto;
            cursor: grab;
            user-select: none;
            display: flex;
            align-items: flex-start;
            justify-content: flex-start;
            padding: .85rem .9rem;
            text-align: left;
            color: #e9eef7;
            line-height: 1.35;
            white-space: normal;
            word-break: break-word;
            transition: transform .12s ease, box-shadow .12s ease, background .12s ease;
        }

        .event:hover {
            transform: translateY(-2px)
        }

        .event.dragging {
            opacity: .75
        }

        .event.correct {
            border-color: #28a745;
            box-shadow: 0 0 0 2px rgba(40, 167, 69, .25) inset
        }

        .event.incorrect {
            border-color: #dc3545;
            box-shadow: 0 0 0 2px rgba(220, 53, 69, .25) inset
        }

        .tl-actions {
            display: flex;
            gap: .6rem;
            flex-wrap: wrap;
            justify-content: center;
            margin-top: .5rem
        }

        .score {
            margin-top: .5rem;
            color: var(--muted);
            text-align: center
        }

        /* small */
        @media(max-width:560px) {
            .brand img {
                height: 52px
            }

            .brand .logo {
                font-size: 1.9rem
            }

            #headline {
                font-size: 1.05rem
            }

            .options {
                grid-template-columns: 1fr
            }
        }
    </style>
</head>

<body>
    <div class="center">
        <main class="screen" aria-live="polite">
            <div class="brand">
                <img src="nextelect-logo.png" alt="NextElect Logo" />
                <h1 class="logo">Issue of the Week</h1>
            </div>

            <!-- Start -->
            <section id="start" class="card">
                <h2>Welcome</h2>
                <p class="muted">Read a neutral summary, play one Bias Buster round, then sort a timeline.</p>
                <div class="btn-row"><button id="go-summary" class="btn">Start</button></div>
            </section>

            <!-- Summary (read-only to players; you edit it in code) -->
            <section id="summary" class="card section hidden">
                <h2>Step 1 · Neutral Summary</h2>
                <div id="issue-title" class="summary-title"></div>
                <div id="issue-summary" class="summary-text"></div>
                <div class="btn-row"><button id="to-bias" class="btn">Continue</button></div>
            </section>

            <!-- Bias Buster (single round, 3 items you set in code) -->
            <section id="bias" class="section hidden">
                <div class="card">
                    <div class="progress-top">
                        <div id="topic-label" class="topic-label">Bias Buster · 1 round (3 headlines)</div>
                        <div class="progress-bar-wrap">
                            <div id="progress-bar"></div>
                        </div>
                    </div>
                    <div class="meta-row">
                        <div id="streak">Streak: 0</div>
                        <div id="correctness">0 / 0</div>
                        <div id="progress">0 / 3</div>
                    </div>

                    <div id="boxes"></div>
                    <div id="headline"></div>
                    <div class="options">
                        <button class="option-btn" data-choice="left">Left</button>
                        <button class="option-btn" data-choice="center">Center</button>
                        <button class="option-btn" data-choice="right">Right</button>
                        <button class="option-btn" data-choice="satire">Satire</button>
                    </div>
                </div>

                <details class="card section">
                    <summary style="cursor:pointer">Sources & notes</summary>
                    <div id="articles" class="articles" style="margin-top:.6rem"></div>
                </details>

                <div class="btn-row">
                    <button id="to-timeline" class="btn small hidden">Go to Timeline</button>
                </div>
            </section>

            <!-- Timeline (hard-gated until Bias Buster is complete) -->
            <section id="timeline" class="card section hidden">
                <div class="tl-head">
                    <h2>Step 3 · Put Events in Order (earliest → latest)</h2>
                    <div class="lives" id="lives">❤️❤️❤️</div>
                </div>

                <div class="event-scroll">
                    <ul id="event-list" class="event-list"></ul>
                </div>

                <div class="tl-actions">
                    <button id="confirm-order" class="btn small">Check Order</button>
                    <button id="reset-order" class="btn small">Reset</button>
                    <button id="reshuffle" class="btn small">Reshuffle</button>
                    <button id="reveal" class="btn small">Reveal</button>
                    <button id="play-again" class="btn small hidden">Play Again</button>
                </div>
                <p id="tl-score" class="score"></p>

                <div class="btn-row" style="margin-top:10px">
                    <button id="finish" class="btn">Finish</button>
                </div>
            </section>

            <!-- Final -->
            <section id="final" class="card section hidden" style="text-align:center">
                <h2>All Set</h2>
                <p class="muted" id="final-note">You can restart for a new issue.</p>
                <div class="btn-row"><button id="restart" class="btn">Restart</button></div>
            </section>
        </main>
    </div>

    <script>
        /* =========================
           CONFIG — YOU EDIT THIS
           ========================= */
        const CONFIG = {
            issue: {
                title: "Sample: Agencies & Executive Power",
                summary:
                    `Officials and courts are weighing how much control the White House has over independent agencies.
Key questions: what legal limits apply, and how would changes affect regulation and enforcement?
Backers say clearer lines improve accountability; critics warn it weakens guardrails and independence.`
            },
            biasRound: [
                {
                    text: "Court will take up dispute over agency independence next term",
                    answer: "center",
                    author: "Example Neutral Outlet",
                    url: "https://example.com/neutral",
                    explanation: "Neutral preview; avoids judgment language."
                },
                {
                    text: "Critics warn plan hands the White House more power over watchdogs",
                    answer: "left",
                    author: "Example Left Outlet",
                    url: "https://example.com/left",
                    explanation: "Leads with critics; frames expansion of executive control."
                },
                {
                    text: "Supporters say federal agencies need stronger presidential oversight",
                    answer: "right",
                    author: "Example Right Outlet",
                    url: "https://example.com/right",
                    explanation: "Positive framing of central oversight."
                }
            ],
            // Set id values so the correct order is ascending by id.
            timelineEvents: [
                { id: 1, text: "Initial proposal to revise oversight rules is unveiled" },
                { id: 2, text: "Key committee holds hearing with agency officials" },
                { id: 3, text: "Court schedules oral argument on the oversight question" },
                { id: 4, text: "Administration releases implementation guidance" },
                { id: 5, text: "Agencies publish responses and next steps" }
            ],
            timelineLives: 3
        };

        /* =========================
           Helpers
           ========================= */
        const $ = (sel) => document.querySelector(sel);
        const $$ = (sel) => Array.from(document.querySelectorAll(sel));
        const esc = (s) => (s || "").replace(/[&<>"']/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;' }[m]));
        const cap = (s) => s ? s[0].toUpperCase() + s.slice(1) : s;

        function showOnly(id) {
            ['start', 'summary', 'bias', 'timeline', 'final'].forEach(x => $('#' + x).classList.add('hidden'));
            $('#' + id).classList.remove('hidden');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        /* =========================
           Step 0 → Step 1: Summary
           ========================= */
        $('#go-summary').addEventListener('click', () => {
            $('#issue-title').textContent = CONFIG.issue.title || "Issue";
            $('#issue-summary').textContent = CONFIG.issue.summary || "";
            showOnly('summary');
        });

        $('#to-bias').addEventListener('click', () => {
            initBias();
            showOnly('bias');
        });

        /* =========================
           Step 2: Bias Buster (1 round)
           ========================= */
        const TOTAL = CONFIG.biasRound.length;
        let bbIndex = 0, bbAnswered = 0, bbScore = 0, bbStreak = 0;

        function initBias() {
            bbIndex = 0; bbAnswered = 0; bbScore = 0; bbStreak = 0;
            buildBoxes();
            updateBBMeta();
            showBBQuestion();
            buildArticles();
            // keep timeline button hidden until we finish
            $('#to-timeline').classList.add('hidden');
        }

        function buildBoxes() {
            const boxes = $('#boxes');
            boxes.innerHTML = '';
            for (let i = 0; i < TOTAL; i++) {
                const div = document.createElement('div');
                div.className = 'box';
                boxes.appendChild(div);
            }
        }

        function updateBBMeta() {
            $('#topic-label').textContent = `Bias Buster · 1 round (${TOTAL} headlines)`;
            $('#progress-bar').style.width = `${(bbAnswered / TOTAL) * 100}%`;
            $('#streak').textContent = `Streak: ${bbStreak}`;
            $('#correctness').textContent = bbAnswered ? `${bbScore} / ${bbAnswered}` : '0 / 0';
            $('#progress').textContent = `${bbAnswered} / ${TOTAL}`;
        }

        function showBBQuestion() {
            const q = CONFIG.biasRound[bbIndex];
            $('#headline').textContent = q.text;
            $$('.option-btn').forEach(b => b.disabled = false);
        }

        function handleBias(choice) {
            const q = CONFIG.biasRound[bbIndex];
            const box = $$('#boxes .box')[bbIndex];
            $$('.option-btn').forEach(b => b.disabled = true);

            if (choice === q.answer) {
                bbScore++; bbStreak++;
                box.classList.add('correct', 'flash');
                box.textContent = `✅ Correct (${cap(q.answer)}) | Source: ${q.author || 'Source'}`;
                setTimeout(() => box.classList.remove('flash'), 420);
            } else {
                bbStreak = 0;
                box.classList.add('incorrect');
                box.textContent = `❌ Correct bias: ${cap(q.answer)} | Source: ${q.author || 'Source'}`;
                $('#headline').classList.add('shake');
                $('#headline').addEventListener('animationend', () => $('#headline').classList.remove('shake'), { once: true });
            }

            bbAnswered++; updateBBMeta();

            setTimeout(() => {
                bbIndex++;
                if (bbIndex < TOTAL) {
                    showBBQuestion();
                } else {
                    // unlock timeline
                    $('#to-timeline').classList.remove('hidden');
                }
            }, 520);
        }

        $$('.option-btn').forEach(btn => btn.addEventListener('click', () => handleBias(btn.dataset.choice)));

        function buildArticles() {
            const root = $('#articles');
            root.innerHTML = '';
            CONFIG.biasRound.forEach((h, i) => {
                const card = document.createElement('div');
                card.className = 'article';
                card.innerHTML = `
          <div class="muted" style="margin-bottom:.2rem">${i + 1}. ${esc(h.author || '')}</div>
          <div style="color:#e9eef7;margin-bottom:.3rem">${esc(h.text)}</div>
          <div class="muted" style="font-size:.9rem">
            <span style="background:#444a57;color:#eaeef6;padding:.06rem .5rem;border-radius:999px;font-size:.8em">${esc(cap(h.answer))}</span>
            &nbsp;•&nbsp;<a href="${esc(h.url || '#')}" target="_blank" rel="noopener">Open</a>
          </div>
          ${h.explanation ? `<div style="margin-top:.45rem;color:#e9eef7">${esc(h.explanation)}</div>` : ``}
        `;
                root.appendChild(card);
            });
        }

        // Hard gate navigation
        $('#to-timeline').addEventListener('click', () => {
            if (bbAnswered < TOTAL) {
                $('#headline').classList.add('shake');
                $('#headline').addEventListener('animationend', () => $('#headline').classList.remove('shake'), { once: true });
                return;
            }
            initTimeline();
            showOnly('timeline');
        });

        /* =========================
           Step 3: Timeline (DnD with lives + replay)
           ========================= */
        let lives = CONFIG.timelineLives;
        let startLayout = []; // for reset
        function updateLives() { $('#lives').textContent = '❤️'.repeat(Math.max(0, lives)) }

        function initTimeline() {
            lives = CONFIG.timelineLives;
            updateLives();
            buildTimeline(shuffle([...CONFIG.timelineEvents]));
            $('#tl-score').textContent = '';
            $('#play-again').classList.add('hidden');
        }

        function shuffle(arr) {
            for (let i = arr.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [arr[i], arr[j]] = [arr[j], arr[i]];
            }
            return arr;
        }

        function buildTimeline(items) {
            const list = $('#event-list');
            list.innerHTML = '';
            items.forEach(ev => {
                const li = document.createElement('li');
                li.className = 'event';
                li.draggable = true;
                li.dataset.id = ev.id;
                li.innerHTML = `
          <div style="display:flex;gap:.55rem;align-items:flex-start">
            <div style="opacity:.7">☰</div>
            <div class="event-text">${esc(ev.text)}</div>
          </div>
        `;
                list.appendChild(li);
            });
            startLayout = currentIds(); // snapshot for Reset
            wireDnD();
        }

        function currentIds() {
            return $$('#event-list .event').map(n => parseInt(n.dataset.id, 10));
        }

        function correctIds() {
            return [...CONFIG.timelineEvents].sort((a, b) => a.id - b.id).map(e => e.id);
        }

        function scoreTimeline({ reveal = false } = {}) {
            const order = currentIds();
            const correct = correctIds();
            let hits = 0;
            $$('#event-list .event').forEach((n, i) => {
                const ok = order[i] === correct[i];
                if (ok) hits++;
                n.classList.toggle('correct', ok);
                n.classList.toggle('incorrect', !ok && !reveal);
            });

            const total = correct.length;
            if (reveal) {
                $('#tl-score').textContent = `Correct order shown. (${hits}/${total} in your last attempt)`;
            } else {
                const pct = Math.round((hits / total) * 100);
                $('#tl-score').textContent = `You placed ${hits} of ${total} correctly (${pct}%). Lives left: ${lives}`;
            }
            return hits === total;
        }

        function wireDnD() {
            const list = $('#event-list');
            let dragging = null;

            $$('#event-list .event').forEach(el => {
                el.addEventListener('dragstart', e => {
                    dragging = el;
                    el.classList.add('dragging');
                    e.dataTransfer.effectAllowed = 'move';
                    e.dataTransfer.setData('text/plain', el.dataset.id); // Firefox
                    // clear previous marks
                    $$('#event-list .event').forEach(n => n.classList.remove('correct', 'incorrect'));
                });
                el.addEventListener('dragend', () => {
                    if (dragging) { dragging.classList.remove('dragging'); dragging = null; }
                });
            });

            list.addEventListener('dragover', e => {
                e.preventDefault();
                if (!dragging) return;

                const after = closestInsertionPoint(list, e.clientX, e.clientY, dragging);
                if (after == null) list.appendChild(dragging);
                else list.insertBefore(dragging, after);
            });

            list.addEventListener('drop', e => e.preventDefault());
        }

        function closestInsertionPoint(container, x, y, ignore) {
            const els = [...container.querySelectorAll('.event')].filter(n => n !== ignore);
            if (els.length === 0) return null;

            // Nearest card center by distance
            let best = { el: null, d2: Infinity };
            for (const el of els) {
                const r = el.getBoundingClientRect();
                const cx = r.left + r.width / 2;
                const cy = r.top + r.height / 2;
                const dx = x - cx, dy = y - cy;
                const d2 = dx * dx + dy * dy;
                if (d2 < best.d2) best = { el, d2 };
            }
            if (!best.el) return null;

            // Insert before or after based on pointer vs center X
            const r = best.el.getBoundingClientRect();
            const after = x > (r.left + r.width / 2);
            return after ? best.el.nextSibling : best.el;
        }

        // Timeline controls + replay with lives
        $('#confirm-order').addEventListener('click', () => {
            const win = scoreTimeline({ reveal: false });
            if (win) {
                $('#tl-score').textContent += ' · Perfect! 🎯';
                $('#play-again').classList.remove('hidden');
                return;
            }
            lives--;
            updateLives();
            if (lives <= 0) {
                $('#tl-score').textContent += ' · Out of lives. Here is the correct order.';
                revealOrder();
                $('#play-again').classList.remove('hidden');
            }
        });

        function revealOrder() {
            const ordered = [...CONFIG.timelineEvents].sort((a, b) => a.id - b.id);
            buildTimeline(ordered);
            scoreTimeline({ reveal: true });
        }

        $('#reveal').addEventListener('click', revealOrder);

        $('#reshuffle').addEventListener('click', () => {
            buildTimeline(shuffle([...CONFIG.timelineEvents]));
            $('#tl-score').textContent = '';
            // lives unchanged; this is just another try
        });

        $('#reset-order').addEventListener('click', () => {
            const byId = Object.fromEntries(CONFIG.timelineEvents.map(e => [e.id, e]));
            const items = startLayout.map(id => byId[id]);
            buildTimeline(items);
            $('#tl-score').textContent = '';
        });

        $('#play-again').addEventListener('click', () => {
            // Full timeline replay: reset lives and reshuffle
            lives = CONFIG.timelineLives;
            updateLives();
            buildTimeline(shuffle([...CONFIG.timelineEvents]));
            $('#tl-score').textContent = '';
            $('#play-again').classList.add('hidden');
        });

        // Finish
        $('#finish').addEventListener('click', () => {
            const lines = [
                `Issue: ${CONFIG.issue.title}`,
                `Bias Buster: ${bbScore} / ${TOTAL}`,
                `Timeline lives left: ${lives}`
            ];
            $('#final-note').textContent = lines.join(' · ');
            showOnly('final');
        });
        $('#restart').addEventListener('click', () => location.reload());
    </script>
</body>

</html>
