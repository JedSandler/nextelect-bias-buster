<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>NextElect — Issue of the Week (Draft 7)</title>
  <style>
    /* ===== Theme / Base ===== */
    *{margin:0;padding:0;box-sizing:border-box}
    html,body{height:100%}
    :root{
      --bg:#3c3f46;
      --fg:#f2f2f2;
      --muted:#d5d5d5;
      --tile:#f7f7f7;
      --tile-border:#dcdcdc;
      --green-bg:#d4edda;
      --green-fg:#155724;
      --red-bg:#f8d7da;
      --red-fg:#721c24;
      --accent:#e6e6e6;
      --card:#2b2f36;
      --card-border:#3a3e47;
      --link-modal:#cfe2ff; /* lighter (Sources & Links modal / final) */
      --link-bias:#aecdff;  /* slightly darker (Bias Buster only) */
    }
    body{
      font-family: Verdana, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:var(--bg);
      color:var(--fg);
      min-height:100vh;
      display:flex;
      flex-direction:column;
    }
    .hidden{display:none!important}
    .center{
      flex:1;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:12px 12px 24px;
    }
    .screen{
      width:100%;
      max-width:920px;
      margin:0 auto;
    }

    /* Branding row */
    .brand{
      display:flex;
      align-items:center;
      justify-content:center;
      gap:.8rem;
      margin:0 0 12px;
    }
    .brand img{height:64px}
    .brand .logo{font-size:2.2rem}

    /* Card shell */
    .card{
      background:var(--card);
      border:1px solid var(--card-border);
      border-radius:14px;
      padding:1rem 1rem;
      box-shadow:0 12px 30px rgba(0,0,0,.25);
      display:flex;
      flex-direction:column;
      align-items:center;
      text-align:center;
    }
    .section{margin-top:12px}

    h1,h2,h3{line-height:1.2}
    .muted{color:var(--muted)}
    .center-text{text-align:center}

    /* Buttons */
    button{font-family:inherit}
    .btn{
      background:#34363d;
      color:var(--fg);
      padding:.8rem 1.4rem;
      font-size:1rem;
      border:1px solid #474a53;
      border-radius:10px;
      cursor:pointer;
      transition:background .2s,transform .08s;
    }
    .btn:hover{
      background:#3b3e46;
      transform:translateY(-1px);
    }
    .btn.small{
      padding:.6rem 1rem;
      font-size:.95rem;
    }
    .btn-row{
      display:flex;
      gap:.6rem;
      flex-wrap:wrap;
      justify-content:center;
      margin-top:.8rem;
    }

    /* Floating Sources button (final page only) */
    .side-fab{
      position:fixed;
      right:18px;
      bottom:18px;
      width:52px;
      height:52px;
      border-radius:50%;
      background:#34363d;
      color:var(--fg);
      border:1px solid #474a53;
      box-shadow:0 6px 16px rgba(0,0,0,.35);
      cursor:pointer;
      font-size:22px;
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:40;
    }
    .side-fab:hover{background:#3b3e46}

    /* Modal for sources/links */
    .modal{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.55);
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:50;
    }
    .modal-card{
      background:var(--card);
      color:var(--fg);
      border:1px solid var(--card-border);
      border-radius:14px;
      width:min(96%, 720px);
      padding:1rem 1rem 1rem;
      box-shadow:0 12px 30px rgba(0,0,0,.35);
    }
    .modal-card h3{
      font-size:1.2rem;
      margin-bottom:.4rem;
    }
    .modal-card .close-x{
      float:right;
      background:transparent;
      border:1px solid #4a4f58;
      color:#cfd6df;
      border-radius:6px;
      padding:.25rem .45rem;
      cursor:pointer;
    }
    .modal-card .close-x:hover{background:#3b3e46}

    .links-list a,
    .src-row a{
      color:var(--link-modal);
      text-decoration:underline;
    }
    .src-row{
      margin:.35rem 0;
    }
    .src-row small{
      color:#cfd6df;
    }

    /* Image blocks (summary hero, bias cards) */
    .top-image-wrap{
      width:100%;
      max-width:360px;      /* back to smaller size */
      border-radius:10px;
      overflow:hidden;
      border:1px solid #4a4f58;
      box-shadow:0 8px 20px rgba(0,0,0,.4);
      margin:0 auto 1rem auto;
      background:#1f2024;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .top-image-wrap img{
      display:block;
      width:100%;
      height:auto;
      object-fit:cover;
    }

    /* Collapsible credit under summary image */
    details.image-credit{
      width:100%;
      max-width:360px;      /* match the image width */
      margin:0 auto 1rem auto;
      background:#2f323a;
      border:1px solid #4a4f58;
      border-radius:8px;
      padding:.6rem .8rem;
      color:var(--muted);
      text-align:left;
      font-size:.9rem;
      line-height:1.4;
      box-shadow:0 6px 16px rgba(0,0,0,.35);
    }
    details.image-credit summary{
      cursor:pointer;
      color:#e9eef7;
      font-weight:600;
      outline:none;
      list-style:none;
    }
    details.image-credit summary::-webkit-details-marker{display:none}
    details.image-credit code{
      color:#cfe2ff;
      word-break:break-all;
      font-size:.8rem;
    }

    /* Home content */
    .home-title{
      font-size:1.35rem;
      margin:8px 0 6px;
    }
    ol.instructions{
      margin:.6rem auto 0;
      max-width:680px;
      text-align:left;
      color:#e9eef7;
      line-height:1.45;
      padding-left:1.1rem;
    }
    ol.instructions li{
      margin:.3rem 0;
    }

    /* Summary text */
    .summary-title{
      font-size:1.2rem;
      color:#e9eef7;
      margin:.2rem 0 .5rem;
    }
    .summary-list{
      margin:.2rem auto 0;
      line-height:1.5;
      max-width:760px;
      text-align:left;
    }
    .summary-list li{
      margin:.25rem 0;
    }

    /* Bias Buster layout */
    .progress-top{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:.75rem;
      margin-bottom:.5rem;
      width:100%;
      max-width:760px;
      text-align:left;
    }
    .topic-label{
      font-size:1rem;
      color:var(--muted);
      text-align:left;
    }
    .progress-bar-wrap{
      flex:1;
      height:8px;
      background:#3a3d46;
      border-radius:5px;
      overflow:hidden;
    }
    #progress-bar{
      height:100%;
      width:0%;
      background:var(--accent);
      transition:width .25s ease;
    }
    .meta-row{
      display:flex;
      align-items:center;
      justify-content:flex-end;
      margin:.4rem 0 .7rem;
      color:var(--muted);
      width:100%;
      max-width:760px;
    }
    #progress{
      font-weight:600;
    }

    #answer-history{
      display:grid;
      grid-template-columns:repeat(3,1fr);
      gap:.5rem;
      margin-bottom:.8rem;
      width:100%;
      max-width:760px;
      text-align:left;
    }

    .box{
      min-height:64px;
      background:var(--tile);
      border:1px solid var(--tile-border);
      border-radius:12px;
      display:flex;
      flex-direction:column;
      gap:.5rem;
      align-items:flex-start;
      justify-content:flex-start;
      box-shadow:0 2px 0 #cfcfcf;
      padding:.6rem .7rem .7rem .7rem;
      color:#202020;
      text-align:left;
    }
    .box.correct{
      border-color:#28a745;
      background:var(--green-bg);
      color:var(--green-fg);
    }
    .box.incorrect{
      border-color:#dc3545;
      background:var(--red-bg);
      color:var(--red-fg);
    }

    .box-img-wrap{
      width:100%;
      border-radius:8px;
      overflow:hidden;
      border:1px solid rgba(0,0,0,.15);
      background:#fff;
    }
    .box-img-wrap img{
      display:block;
      width:100%;
      height:auto;
      object-fit:cover;
    }

    .box .src{
      font-size:.9rem;
      opacity:.85;
      line-height:1.4;
    }
    .box .src a{
      color:var(--link-bias);
      text-decoration:underline;
    }

    #headline{
      background:var(--tile);
      color:#111;
      padding:1.1rem 1rem;
      border-radius:14px;
      border:1px solid var(--tile-border);
      box-shadow:0 2px 0 #cfcfcf;
      margin:.2rem 0 1rem;
      min-height:3.8rem;
      font-size:1.2rem;
      line-height:1.35;
      text-align:center;
      width:100%;
      max-width:760px;
    }

    .options{
      display:grid;
      grid-template-columns:repeat(3,1fr);
      gap:.6rem;
      margin:.2rem 0 0;
      width:100%;
      max-width:760px;
    }
    .option-btn{
      background:var(--tile);
      color:#111;
      padding:.9rem .8rem;
      border-radius:12px;
      border:1px solid var(--tile-border);
      cursor:pointer;
      transition:transform .06s ease,background .15s ease;
      box-shadow:0 2px 0 #cfcfcf;
      font-weight:600;
      text-align:center;
    }
    .option-btn:hover{
      background:#ededed;
      transform:translateY(-1px);
    }

    @keyframes shake{
      0%,100%{transform:translateX(0)}
      25%{transform:translateX(-6px)}
      75%{transform:translateX(6px)}
    }
    .shake{animation:shake .22s}

    /* Timeline layout */
    .tl-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:.75rem;
      flex-wrap:wrap;
      width:100%;
      max-width:760px;
      text-align:left;
    }
    .lives{
      color:#ffb3b3;
      font-weight:600;
    }
    .event-list{
      display:flex;
      flex-direction:column;
      gap:.6rem;
      list-style:none;
      margin:.8rem 0 0;
      width:100%;
      max-width:760px;
      text-align:left;
    }
    .event{
      background:#34363d;
      border:1px solid #4a4f58;
      border-radius:12px;
      width:100%;
      min-height:86px;
      cursor:grab;
      user-select:none;
      display:flex;
      align-items:flex-start;
      justify-content:flex-start;
      padding:.85rem .9rem;
      text-align:left;
      color:#e9eef7;
      line-height:1.35;
      white-space:normal;
      word-break:break-word;
      transition:transform .12s ease,box-shadow .12s ease,background .12s ease;
    }
    .event:hover{transform:translateY(-2px)}
    .event.dragging{opacity:.8}
    .event.correct{
      border-color:#28a745;
      box-shadow:0 0 0 2px rgba(40,167,69,.25) inset;
    }
    .event.incorrect{
      border-color:#dc3545;
      box-shadow:0 0 0 2px rgba(220,53,69,.25) inset;
    }

    .tl-actions{
      display:flex;
      gap:.6rem;
      flex-wrap:wrap;
      justify-content:center;
      margin-top:.8rem;
      width:100%;
      max-width:760px;
    }
    .score{
      margin-top:.5rem;
      color:var(--muted);
      text-align:center;
      width:100%;
      max-width:760px;
    }

    /* Final results */
    .final-big{
      font-size:1.3rem;
      margin-bottom:.25rem;
      text-align:center;
    }
    .final-sub{
      color:#e9eef7;
      margin:.25rem 0 .6rem;
      text-align:center;
    }

    /* Small screens */
    @media(max-width:560px){
      .brand img{height:52px}
      .brand .logo{font-size:1.9rem}
      #headline{font-size:1.05rem}
      .options{grid-template-columns:1fr}
      #answer-history{grid-template-columns:1fr 1fr 1fr}
    }
  </style>
</head>
<body>
  <div class="center">
    <main class="screen" aria-live="polite">

      <!-- Global header -->
      <div class="brand">
        <img src="nextelect-logo.png" alt="NextElect Logo"/>
        <h1 class="logo">NextElect — Issue of the Week</h1>
      </div>

      <!-- ===== HOME ===== -->
      <section id="home" class="card center-text">
        <!-- Note: image moved off home to summary -->
        <h2 class="home-title">Welcome to NextElect</h2>
        <p class="muted">Your weekly, unbiased practice on news reading.</p>
        <ol class="instructions">
          <li>Read a short, neutral overview of this week’s issue.</li>
          <li>Play Bias Buster: identify the framing (Left, Center, Right) for 3 headlines.</li>
          <li>Put 5 key events in correct order. You have 3 lives.</li>
        </ol>
        <div class="btn-row"><button id="start-btn" class="btn">Start</button></div>
      </section>

      <!-- ===== PART 1: SUMMARY ===== -->
      <section id="summary" class="card section hidden">

        <!-- Issue image (now in Summary, with credit dropdown) -->
        <div class="top-image-wrap" id="issue-image-wrap">
          <img id="issue-image" src="" alt="Issue image preview"/>
        </div>

        <details id="issue-image-credit" class="image-credit hidden">
          <summary>Image credit / source</summary>
          <div style="margin-top:.4rem">
            <div style="color:#d5d5d5;font-size:.8rem;line-height:1.4">
              <div>This image relates to this week's issue.</div>
              <div>URL: <code id="issue-image-credit-url"></code></div>
            </div>
          </div>
        </details>

        <h2>Part 1 · Summary</h2>
        <div style="margin:.3rem 0 .6rem">
          <img src="nextelect-logo.png" alt="NextElect Logo" style="height:44px;vertical-align:middle"/>
        </div>
        <div id="issue-title" class="summary-title"></div>
        <ul id="issue-summary" class="summary-list"></ul>
        <div class="btn-row"><button id="to-bias" class="btn">Start Playing</button></div>
      </section>

      <!-- ===== PART 2: BIAS BUSTER ===== -->
      <section id="bias" class="card section hidden">

        <!-- Current headline image -->
        <div class="top-image-wrap hidden" id="headline-image-wrap">
          <img id="headline-image" src="" alt="Headline image preview"/>
        </div>

        <div class="progress-top">
          <div id="topic-label" class="topic-label">Part 2 · Bias Buster</div>
          <div class="progress-bar-wrap"><div id="progress-bar"></div></div>
        </div>

        <div class="meta-row">
          <div id="progress">0 / 3</div>
        </div>

        <!-- Answer history with per-article image + correctness + source -->
        <div id="answer-history"></div>

        <!-- Current headline text -->
        <div id="headline"></div>

        <!-- Choices -->
        <div class="options">
          <button class="option-btn" data-choice="left">Left</button>
          <button class="option-btn" data-choice="center">Center</button>
          <button class="option-btn" data-choice="right">Right</button>
        </div>
      </section>

      <!-- ===== PART 3: TIMELINE ===== -->
      <section id="timeline" class="card section hidden">
        <div class="tl-head">
          <h2>Part 3 · Timeline (earliest → latest)</h2>
          <div class="lives" id="lives"></div>
        </div>

        <ul id="event-list" class="event-list"></ul>

        <div class="tl-actions">
          <button id="check-order" class="btn small">Check Order</button>
          <button id="reset-order" class="btn small">Reset</button>
          <button id="reshuffle" class="btn small">Reshuffle</button>
          <button id="reveal" class="btn small">Reveal</button>
          <button id="to-final-after-reveal" class="btn small hidden">Go to Results</button>
        </div>

        <p id="tl-score" class="score"></p>
      </section>

      <!-- ===== FINAL ===== -->
      <section id="final" class="card section hidden">
        <h2 class="final-big">Final Results</h2>
        <p id="final-line" class="final-sub"></p>
      </section>

    </main>
  </div>

  <!-- Floating Sources & Links button (Final only) -->
  <button id="fab-sources" class="side-fab hidden" aria-label="Sources & Links">🔗</button>

  <!-- Sources & Links Modal -->
  <div id="sources-modal" class="modal hidden" role="dialog" aria-modal="true">
    <div class="modal-card">
      <button id="sources-close" class="close-x" aria-label="Close">×</button>
      <h3>Sources & Links</h3>
      <p class="muted" style="margin:.25rem 0 .5rem">
        These are the articles used in Bias Buster. Your checkmarks reflect how you answered.
      </p>
      <div id="final-sources" style="margin:.4rem 0 .6rem"></div>
      <hr style="border:0;border-top:1px solid #4a4f58;margin:.6rem 0">
      <div class="links-list">
        <p><a href="https://redbluedictionary.org" target="_blank" rel="noopener">Red/Blue Dictionary</a></p>
        <p><a href="https://www.allsides.com" target="_blank" rel="noopener">AllSides</a></p>
        <p><a href="https://ground.news" target="_blank" rel="noopener">Ground News</a></p>
        <p><a href="https://mediabiasfactcheck.com" target="_blank" rel="noopener">Media Bias/Fact Check</a></p>
      </div>
    </div>
  </div>

  <script>
    /* =========================
       CONFIG — YOU EDIT THIS
       ========================= */
    const CONFIG = {
      dateLabel: "10/16/2025",

      // Image for the summary page
      issueImage: "https://d3i6fh83elv35t.cloudfront.net/static/2025/10/AP25296603874064-1024x685.jpg",

      // Optional descriptive credit. We'll display the actual URL separately in the dropdown.
      issueImageCredit: "Associated Press / White House construction photo (Oct 2025).",

      issue: {
        title: "White House Ballroom Construction Fight",
        summaryBullets: [
          "The White House said it will submit plans for President Donald Trump's $250 million White House ballroom project to a federal oversight body, even though demolition work has already begun.",
          "Trump praised the construction noise for the new ballroom, which would be a major physical change to the historic building.",
          "The Treasury Department told employees not to share photos of demolition work in the East Wing after images spread online."
        ]
      },

      // Bias Buster headlines (3). Each can have its own image.
      biasRound: [
        {
          text: "Trump’s White House Ballroom Sparks Questions About Funding and Ethics",
          answer: "left",
          author: "FactCheck.org",
          url: "https://www.factcheck.org/2025/10/trumps-white-house-ballroom-sparks-questions-about-funding-and-ethics",
          image: "https://example.com/ethics-questions.jpg"
        },
        {
          text: "Trump celebrates White House demolition as new ballroom rises: 'Music to my Ears'",
          answer: "right",
          author: "Fox News",
          url: "https://www.foxnews.com/politics/trump-celebrates-white-house-demolition-new-ballroom-rises-music-my-ears",
          image: "https://example.com/trump-smiling.jpg"
        },
        {
          text: "Treasury Tells Employees Not to Share Photos of White House Ballroom Construction",
          answer: "center",
          author: "Wall Street Journal",
          url: "https://www.wsj.com/politics/policy/treasury-tells-employees-not-to-share-photos-of-white-house-ballroom-construction-1d4f2c49",
          image: "https://example.com/no-photos-memo.jpg"
        }
      ],

      // Timeline events in correct chronological order by id
      timelineEvents: [
        { id: 1, text: "The White House Announces Ballroom Construction" },
        { id: 2, text: "Demolition and Construction begin on the ballroom" },
        { id: 3, text: "Many lawmakers, especially Democrats, denounce demolition" },
        { id: 4, text: "Treasury Dept tells employees not to photograph construction" },
        { id: 5, text: "Trump announces that the entire East Wing is to be demolished" }
      ],

      timelineLives: 3
    };

    /* =========================
       DOM helpers
       ========================= */
    const $ = (sel) => document.querySelector(sel);
    const $$ = (sel) => Array.from(document.querySelectorAll(sel));
    const esc = (s) => (s||"").replace(/[&<>"']/g, m => (
      {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m]
    ));
    const cap = (s) => s ? s[0].toUpperCase() + s.slice(1) : s;

    function showOnly(id){
      ['home','summary','bias','timeline','final'].forEach(x => $('#'+x).classList.add('hidden'));
      $('#'+id).classList.remove('hidden');
      window.scrollTo({top:0, behavior:'smooth'});
    }

    /* =========================
       HOME → SUMMARY
       ========================= */
    $('#start-btn').addEventListener('click', () => {
      // Fill summary title/date
      $('#issue-title').textContent = `${CONFIG.dateLabel} · ${CONFIG.issue.title}`;

      // Fill the bullet points
      const list = $('#issue-summary');
      list.innerHTML = '';
      CONFIG.issue.summaryBullets.forEach(b => {
        const li = document.createElement('li');
        li.textContent = b;
        list.appendChild(li);
      });

      // Fill the summary image and credit dropdown
      if (CONFIG.issueImage && CONFIG.issueImage.trim() !== "") {
        $('#issue-image').src = CONFIG.issueImage;
        $('#issue-image').alt = CONFIG.issue.title || "Issue image";
        $('#issue-image-wrap').classList.remove('hidden');

        // Fill dropdown credit and show it
        $('#issue-image-credit-url').textContent = CONFIG.issueImage;
        // We show both: the descriptive credit, and the URL in code block
        // If there's no descriptive credit, we still show the dropdown because you asked
        $('#issue-image-credit').classList.remove('hidden');
      } else {
        $('#issue-image-wrap').classList.add('hidden');
        $('#issue-image-credit').classList.add('hidden');
      }

      showOnly('summary');
    });

    /* =========================
       SUMMARY → BIAS
       ========================= */
    $('#to-bias').addEventListener('click', () => {
      initBias();
      showOnly('bias');
    });

    /* =========================
       BIAS BUSTER LOGIC
       ========================= */
    const TOTAL = 3;
    let bbIndex = 0;
    let bbAnswered = 0;
    let bbScore = 0;

    function initBias(){
      bbIndex = 0;
      bbAnswered = 0;
      bbScore = 0;

      $('#topic-label').textContent = "Part 2 · Bias Buster";
      $('#progress-bar').style.width = '0%';
      $('#progress').textContent = `0 / ${TOTAL}`;
      $('#answer-history').innerHTML = '';

      showBBQuestion();
    }

    function showBBQuestion(){
      const q = CONFIG.biasRound[bbIndex];

      // Headline text
      $('#headline').textContent = q.text;

      // Question image
      if (q.image && q.image.trim() !== "") {
        $('#headline-image').src = q.image;
        $('#headline-image').alt = q.text;
        $('#headline-image-wrap').classList.remove('hidden');
      } else {
        $('#headline-image-wrap').classList.add('hidden');
      }

      // Enable buttons
      $$('.option-btn').forEach(b => b.disabled = false);
    }

    function appendHistory(correct, item){
      const box = document.createElement('div');
      box.className = 'box ' + (correct ? 'correct' : 'incorrect');
      const status = correct ? '✅ Correct' : '❌ Correct bias';

      // optional per-article image
      const imgHTML = (item.image && item.image.trim() !== "")
        ? `<div class="box-img-wrap"><img src="${esc(item.image)}" alt="${esc(item.text)}"></div>`
        : '';

      box.innerHTML = `
        ${imgHTML}
        <div><strong>${status}:</strong> ${cap(item.answer)}</div>
        <div class="src">
          Source: ${esc(item.author||'')}
          ${item.url ? ` • <a href="${esc(item.url)}" target="_blank" rel="noopener">Open</a>` : ''}
        </div>
      `;
      $('#answer-history').appendChild(box);
    }

    function handleBias(choice){
      const q = CONFIG.biasRound[bbIndex];

      // Lock buttons
      $$('.option-btn').forEach(b => b.disabled = true);

      // Score
      const correct = (choice === q.answer);
      if(correct) bbScore++;

      appendHistory(correct, q);

      bbAnswered++;
      $('#progress').textContent = `${bbAnswered} / ${TOTAL}`;
      $('#progress-bar').style.width = `${(bbAnswered/TOTAL)*100}%`;

      setTimeout(() => {
        bbIndex++;
        if (bbIndex < TOTAL){
          showBBQuestion();
        } else {
          // straight to timeline
          initTimeline();
          showOnly('timeline');
        }
      }, 450);
    }

    $$('.option-btn').forEach(btn => {
      btn.addEventListener('click', () => handleBias(btn.dataset.choice));
    });

    /* =========================
       TIMELINE LOGIC
       ========================= */
    let lives = CONFIG.timelineLives;
    let startLayout = []; // remember layout for Reset

    function hearts(n){
      return '❤️'.repeat(Math.max(0,n));
    }
    function updateLives(){
      $('#lives').innerHTML = `Lives: ${lives} ${hearts(lives)}`;
    }

    function initTimeline(){
      lives = CONFIG.timelineLives;
      updateLives();
      buildTimeline(shuffle([...CONFIG.timelineEvents]));
      $('#tl-score').textContent = '';
      $('#to-final-after-reveal').classList.add('hidden');
    }

    function shuffle(arr){
      for(let i=arr.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [arr[i],arr[j]] = [arr[j],arr[i]];
      }
      return arr;
    }

    function buildTimeline(items){
      const list = $('#event-list');
      list.innerHTML = '';
      items.forEach(ev => {
        const li = document.createElement('li');
        li.className = 'event';
        li.draggable = true;
        li.dataset.id = ev.id;
        li.innerHTML = `
          <div style="display:flex;gap:.55rem;align-items:flex-start">
            <div style="opacity:.7">☰</div>
            <div class="event-text">${esc(ev.text)}</div>
          </div>
        `;
        list.appendChild(li);
      });
      startLayout = currentIds();
      wireDnDVertical();
    }

    function currentIds(){
      return $$('#event-list .event').map(n => parseInt(n.dataset.id,10));
    }
    function correctIds(){
      return [...CONFIG.timelineEvents]
        .sort((a,b)=>a.id - b.id)
        .map(e => e.id);
    }

    function scoreTimeline({reveal=false} = {}){
      const order = currentIds();
      const correct = correctIds();

      let hits = 0;
      $$('#event-list .event').forEach((n,i) => {
        const ok = order[i] === correct[i];
        if(ok) hits++;
        n.classList.toggle('correct', ok);
        n.classList.toggle('incorrect', !ok && !reveal);
      });

      const total = correct.length;
      const pct = Math.round((hits/total)*100);

      $('#tl-score').textContent = reveal
        ? `Correct order shown. (Last attempt: ${hits}/${total})`
        : `You placed ${hits} of ${total} correctly (${pct}%). Lives left: ${lives}`;

      return hits === total;
    }

    function wireDnDVertical(){
      const list = $('#event-list');
      let dragging = null;

      $$('#event-list .event').forEach(el => {
        el.addEventListener('dragstart', e => {
          dragging = el;
          el.classList.add('dragging');
          e.dataTransfer.effectAllowed = 'move';
          e.dataTransfer.setData('text/plain', el.dataset.id);

          // clear visual marks at new drag start
          $$('#event-list .event').forEach(n => n.classList.remove('correct','incorrect'));
        });

        el.addEventListener('dragend', () => {
          if(dragging){
            dragging.classList.remove('dragging');
            dragging = null;
          }
        });
      });

      list.addEventListener('dragover', e => {
        e.preventDefault();
        if(!dragging) return;

        const after = closestVertical(list, e.clientY, dragging);
        if(after == null){
          list.appendChild(dragging);
        } else {
          list.insertBefore(dragging, after);
        }
      });

      list.addEventListener('drop', e => e.preventDefault());
    }

    function closestVertical(container, y, ignore){
      const els = [...container.querySelectorAll('.event')].filter(n => n !== ignore);
      if(els.length === 0) return null;

      let best = {el:null, d:Infinity};
      for(const el of els){
        const r = el.getBoundingClientRect();
        const cy = r.top + r.height/2;
        const d = Math.abs(y - cy);
        if(d < best.d){
          best = {el, d};
        }
      }
      if(!best.el) return null;

      const r = best.el.getBoundingClientRect();
      const after = y > (r.top + r.height/2);
      return after ? best.el.nextSibling : best.el;
    }

    // Check order button
    $('#check-order').addEventListener('click', () => {
      const win = scoreTimeline({reveal:false});
      if(win){
        goFinal();
        return;
      }

      lives--;
      updateLives();

      if(lives <= 0){
        $('#tl-score').textContent = "Out of lives. Showing correct order, then taking you to results…";
        revealOrder(true);
        setTimeout(() => goFinal(), 900);
      } else {
        $('#tl-score').textContent += " · Try again.";
      }
    });

    function revealOrder(fromLoss=false){
      const ordered = [...CONFIG.timelineEvents].sort((a,b)=>a.id - b.id);
      buildTimeline(ordered);
      scoreTimeline({reveal:true});

      if(!fromLoss){
        $('#to-final-after-reveal').classList.remove('hidden');
        $('#tl-score').textContent = "Here's the correct order. Ready to see your results?";
      }
    }

    $('#reveal').addEventListener('click', () => revealOrder(false));

    $('#to-final-after-reveal').addEventListener('click', () => goFinal());

    $('#reshuffle').addEventListener('click', () => {
      buildTimeline(shuffle([...CONFIG.timelineEvents]));
      $('#tl-score').textContent = '';
      $('#to-final-after-reveal').classList.add('hidden');
    });

    $('#reset-order').addEventListener('click', () => {
      const byId = Object.fromEntries(CONFIG.timelineEvents.map(e => [e.id, e]));
      const items = startLayout.map(id => byId[id]);
      buildTimeline(items);
      $('#tl-score').textContent = '';
      $('#to-final-after-reveal').classList.add('hidden');
    });

    /* =========================
       FINAL SCORE + SOURCES
       ========================= */
    function goFinal(){
      const livesLeft = Math.max(0, lives);
      const finalScore = bbScore + livesLeft;
      const biasPart = `${bbScore}/3`;
      const livesPart = `${livesLeft}/3`;

      let msg;
      if(finalScore === 6){
        msg = `🔥 Outstanding! Score ${finalScore}/6 — Perfect balance of bias spotting (${biasPart}) and timeline recall (${livesPart}).`;
      } else if(finalScore >= 5){
        msg = `💪 Strong work! Score ${finalScore}/6 — Bias: ${biasPart}. Lives: ${livesPart}. So close to perfect.`;
      } else if(finalScore >= 3){
        msg = `👍 Solid start. Score ${finalScore}/6 — Bias: ${biasPart}. Lives: ${livesPart}. A couple tweaks and you’ll nail it.`;
      } else {
        msg = `🔁 Keep going. Score ${finalScore}/6 — Bias: ${biasPart}. Lives: ${livesPart}. Recheck the summary and try again.`;
      }
      $('#final-line').textContent = msg;

      // Build "Sources & Links" content
      const fs = $('#final-sources');
      fs.innerHTML = '';
      CONFIG.biasRound.forEach((item, i) => {
        const hist = $$('#answer-history .box')[i];
        const gotIt = hist ? hist.classList.contains('correct') : false;
        const row = document.createElement('div');
        row.className = 'src-row';
        row.innerHTML = `${gotIt ? '✅' : '❌'} ${esc(item.text)}<br>
          <small>Bias: ${cap(item.answer)} · Source: ${esc(item.author||'')}${
            item.url ? ` · <a href="${esc(item.url)}" target="_blank" rel="noopener">Open</a>` : ''
          }</small>`;
        fs.appendChild(row);
      });

      showOnly('final');
      $('#fab-sources').classList.remove('hidden');
    }

    // floating Sources button / modal wiring
    const fab = $('#fab-sources');
    const modal = $('#sources-modal');
    const closeBtn = $('#sources-close');

    fab.addEventListener('click', () => modal.classList.remove('hidden'));
    closeBtn.addEventListener('click', () => modal.classList.add('hidden'));
    modal.addEventListener('click', (e) => {
      if(e.target === modal) modal.classList.add('hidden');
    });
  </script>
</body>
</html>
